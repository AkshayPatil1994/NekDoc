

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Routines of Interest &mdash; Nek5000 17.0 documentation</title>
  

  
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="genindex.html"/>
        <link rel="search" title="Search" href="search.html"/>
    <link rel="top" title="Nek5000 17.0 documentation" href="index.html"/>
        <link rel="next" title="Appendices" href="appendix.html"/>
        <link rel="prev" title="Performing Large-Scale Simulations in Nek5000" href="large_scale.html"/> 

  
  <script src="_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="index.html" class="icon icon-home"> Nek5000
          

          
          </a>

          
            
            
              <div class="version">
                17.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="intro.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="quickstart.html">Quickstart</a></li>
<li class="toctree-l1"><a class="reference internal" href="user_files.html">User Files</a></li>
<li class="toctree-l1"><a class="reference internal" href="geometry.html">Geometry</a></li>
<li class="toctree-l1"><a class="reference internal" href="large_scale.html">Performing Large-Scale Simulations in Nek5000</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Routines of Interest</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#naming-conventions">Naming Conventions</a></li>
<li class="toctree-l2"><a class="reference internal" href="#subroutines">Subroutines</a></li>
<li class="toctree-l2"><a class="reference internal" href="#functions">Functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="#an-example-of-specifying-surface-normals-in-the-usr-file">An Example of Specifying Surface Normals in the .usr File</a></li>
<li class="toctree-l2"><a class="reference internal" href="#history-points">History Points</a></li>
<li class="toctree-l2"><a class="reference internal" href="#grid-to-grid-interpolation">Grid-to-Grid Interpolation</a></li>
<li class="toctree-l2"><a class="reference internal" href="#lagrangian-particle-tracking">Lagrangian Particle Tracking</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="appendix.html">Appendices</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Nek5000</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
      <li>Routines of Interest</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/routines.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="routines-of-interest">
<h1>Routines of Interest<a class="headerlink" href="#routines-of-interest" title="Permalink to this headline">¶</a></h1>
<p>The most common routines needed in Nek5000 are</p>
<div class="section" id="naming-conventions">
<h2>Naming Conventions<a class="headerlink" href="#naming-conventions" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">subroutine</span> <span class="pre">f(a,b,c)</span></code><ul>
<li><code class="docutils literal"><span class="pre">a</span></code>- returned variable</li>
<li><code class="docutils literal"><span class="pre">b,c</span></code> -input data</li>
</ul>
</li>
<li><code class="docutils literal"><span class="pre">op[]</span></code> represent operations on operators</li>
<li><code class="docutils literal"><span class="pre">c[]</span></code>  operations on constants</li>
<li><code class="docutils literal"><span class="pre">gl[]</span></code> global operations</li>
<li><code class="docutils literal"><span class="pre">col2[]</span> <span class="pre">---</span></code></li>
<li><code class="docutils literal"><span class="pre">col3[]</span> <span class="pre">--</span></code></li>
</ul>
</div>
<div class="section" id="subroutines">
<h2>Subroutines<a class="headerlink" href="#subroutines" title="Permalink to this headline">¶</a></h2>
<dl class="docutils">
<dt><code class="docutils literal"><span class="pre">subroutine</span> <span class="pre">rescale_x(x,x0,x1)</span></code></dt>
<dd>Rescales the array <code class="docutils literal"><span class="pre">x</span></code> to be in the range <code class="docutils literal"><span class="pre">(x0,x1)</span></code>. This is usually called from <code class="docutils literal"><span class="pre">usrdat2</span></code> in the <code class="docutils literal"><span class="pre">.usr</span></code> file</dd>
<dt><code class="docutils literal"><span class="pre">subroutine</span> <span class="pre">normvc(h1,semi,l2,linf,x1,x2,x3)</span></code></dt>
<dd>Computes the error norms of a vector field variable <code class="docutils literal"><span class="pre">(x1,x2,x3)</span></code> defined on mesh 1, the velocity mesh. The error norms are normalized with respect to the volume, with the exception on the infinity norm, <code class="docutils literal"><span class="pre">linf</span></code>.</dd>
<dt><code class="docutils literal"><span class="pre">subroutine</span> <span class="pre">comp_vort3(vort,work1,work2,u,v,w)</span></code></dt>
<dd>Computes the vorticity (<code class="docutils literal"><span class="pre">vort</span></code>) of the velocity field, <code class="docutils literal"><span class="pre">(u,v,w)</span></code></dd>
<dt><code class="docutils literal"><span class="pre">subroutine</span> <span class="pre">lambda2(l2)</span></code></dt>
<dd>Generates the Lambda-2 vortex criterion proposed by Jeong and Hussain (1995)</dd>
<dt><code class="docutils literal"><span class="pre">subroutine</span> <span class="pre">planar_average_z(ua,u,w1,w2)</span></code></dt>
<dd>Computes the r-s planar average of the quantity <code class="docutils literal"><span class="pre">u</span></code>.</dd>
<dt><code class="docutils literal"><span class="pre">subroutine</span> <span class="pre">torque_calc(scale,x0,ifdout,iftout)</span></code></dt>
<dd>Computes torque about the point <code class="docutils literal"><span class="pre">x0</span></code>. Here scale is a user supplied multiplier so that the results may be scaled to any convenient non-dimensionalization. Both the drag and the torque can be printed to the screen by switching the appropriate <code class="docutils literal"><span class="pre">ifdout(drag)</span></code> or <code class="docutils literal"><span class="pre">iftout(torque)</span></code> logical.</dd>
<dt><code class="docutils literal"><span class="pre">subroutine</span> <span class="pre">set_obj</span></code></dt>
<dd>Defines objects for surface integrals by changing the value of <code class="docutils literal"><span class="pre">hcode</span></code> for future calculations. Typically called once within <code class="docutils literal"><span class="pre">userchk</span></code> (for <code class="docutils literal"><span class="pre">istep</span> <span class="pre">=</span> <span class="pre">0</span></code>) and used for calculating torque. (see above)</dd>
</dl>
<p><code class="docutils literal"><span class="pre">subroutine</span> <span class="pre">avg1(avg,f,</span> <span class="pre">alpha,beta,n,name,ifverbose)</span></code></p>
<p><code class="docutils literal"><span class="pre">subroutine</span> <span class="pre">avg2(avg,f,</span> <span class="pre">alpha,beta,n,name,ifverbose)</span></code></p>
<dl class="docutils">
<dt><code class="docutils literal"><span class="pre">subroutine</span> <span class="pre">avg3(avg,f,g,</span> <span class="pre">alpha,beta,n,name,ifverbose)</span></code></dt>
<dd>These three subroutines calculate the (weighted) average of <code class="docutils literal"><span class="pre">f</span></code>. Depending on the value of the logical, <code class="docutils literal"><span class="pre">ifverbose</span></code>, the results will be printed to standard output along with name. In <code class="docutils literal"><span class="pre">avg2</span></code>, the <code class="docutils literal"><span class="pre">f</span></code> component is squared. In <code class="docutils literal"><span class="pre">avg3</span></code>, vector <code class="docutils literal"><span class="pre">g</span></code> also contributes to the average calculation.</dd>
<dt><code class="docutils literal"><span class="pre">subroutine</span> <span class="pre">outpost(x,vy,vz,pr,tz,'</span> <span class="pre">')</span></code></dt>
<dd>Dumps the current data of <code class="docutils literal"><span class="pre">x</span></code>, <code class="docutils literal"><span class="pre">vy</span></code>, <code class="docutils literal"><span class="pre">vz</span></code>, <code class="docutils literal"><span class="pre">pr</span></code>, <code class="docutils literal"><span class="pre">tz</span></code> to an <code class="docutils literal"><span class="pre">.fld</span></code> or <code class="docutils literal"><span class="pre">.f0????</span></code> file for post processing.</dd>
<dt><code class="docutils literal"><span class="pre">subroutine</span> <span class="pre">platform_timer(ivrb)</span></code></dt>
<dd>Runs the battery of timing tests for matrix-matrix products,contention-free processor-to-processor ping-pong tests, and <code class="docutils literal"><span class="pre">mpi_all_reduce</span></code> times. Allows one to check the performance of the communication routines used on specific platforms.</dd>
<dt><code class="docutils literal"><span class="pre">subroutine</span> <span class="pre">quickmv</span></code></dt>
<dd>Moves the mesh to allow user affine motion.</dd>
<dt><code class="docutils literal"><span class="pre">subroutine</span> <span class="pre">runtimeavg(ay,y,j,istep1,ipostep,s5)</span></code></dt>
<dd>Computes, stores, and (for <code class="docutils literal"><span class="pre">ipostep!0</span></code>) prints runtime averages of <code class="docutils literal"><span class="pre">j</span></code>-quantity <code class="docutils literal"><span class="pre">y</span></code> (along w/ <code class="docutils literal"><span class="pre">y</span></code> itself unless <code class="docutils literal"><span class="pre">ipostep&lt;0</span></code>) with <code class="docutils literal"><span class="pre">j</span></code> + ‘<code class="docutils literal"><span class="pre">rtavg_</span></code>’ + (unique) <code class="docutils literal"><span class="pre">s5</span></code> every <code class="docutils literal"><span class="pre">ipostep</span></code> for <code class="docutils literal"><span class="pre">istep&gt;=istep1</span></code>. <code class="docutils literal"><span class="pre">s5</span></code> is a string to append to <code class="docutils literal"><span class="pre">rtavg_</span></code> for storage file naming.</dd>
<dt><code class="docutils literal"><span class="pre">subroutine</span> <span class="pre">lagrng(uo,y,yvec,uvec,work,n,m)</span></code></dt>
<dd>Compute Lagrangian interpolant for <code class="docutils literal"><span class="pre">uo</span></code></dd>
<dt><code class="docutils literal"><span class="pre">subroutine</span> <span class="pre">opcopy(a1,a2,a3,b1,b2,b3)</span></code></dt>
<dd>Copies <code class="docutils literal"><span class="pre">b1</span></code> to <code class="docutils literal"><span class="pre">a1</span></code>, <code class="docutils literal"><span class="pre">b2</span></code> to <code class="docutils literal"><span class="pre">a2</span></code>, and <code class="docutils literal"><span class="pre">b3</span></code> to <code class="docutils literal"><span class="pre">a3</span></code>, when <code class="docutils literal"><span class="pre">ndim</span> <span class="pre">=</span> <span class="pre">3</span></code>,</dd>
<dt><code class="docutils literal"><span class="pre">subroutine</span> <span class="pre">cadd(a,const,n)</span></code></dt>
<dd>Adds <code class="docutils literal"><span class="pre">const</span></code> to vector <code class="docutils literal"><span class="pre">a</span></code> of size <code class="docutils literal"><span class="pre">n</span></code>.</dd>
<dt><code class="docutils literal"><span class="pre">subroutine</span> <span class="pre">col2(a,b,n)</span></code></dt>
<dd>For <code class="docutils literal"><span class="pre">n</span></code> entries, calculates <code class="docutils literal"><span class="pre">a=a*b</span></code>.</dd>
<dt><code class="docutils literal"><span class="pre">subroutine</span> <span class="pre">col3(a,b,c,n)</span></code></dt>
<dd>For <code class="docutils literal"><span class="pre">n</span></code> entries, calculates <code class="docutils literal"><span class="pre">a=b*c</span></code>.</dd>
</dl>
</div>
<div class="section" id="functions">
<h2>Functions<a class="headerlink" href="#functions" title="Permalink to this headline">¶</a></h2>
<p><code class="docutils literal"><span class="pre">function</span> <span class="pre">glmax(a,n)</span></code></p>
<p><code class="docutils literal"><span class="pre">function</span> <span class="pre">glamax(a,n)</span></code></p>
<dl class="docutils">
<dt><code class="docutils literal"><span class="pre">function</span> <span class="pre">iglmax(a,n)</span></code></dt>
<dd>Calculates the (absolute) max of a vector that is size <code class="docutils literal"><span class="pre">n</span></code>. Prefix <code class="docutils literal"><span class="pre">i</span></code> implies integer type.</dd>
<dt><code class="docutils literal"><span class="pre">function</span> <span class="pre">i8glmax(a,n)</span></code></dt>
<dd>Calculates the max of an integer*8 vector that is size <code class="docutils literal"><span class="pre">n</span></code>.</dd>
</dl>
<p><code class="docutils literal"><span class="pre">function</span> <span class="pre">glmin(a,n)</span></code></p>
<p><code class="docutils literal"><span class="pre">function</span> <span class="pre">glamin(a,n)</span></code></p>
<dl class="docutils">
<dt><code class="docutils literal"><span class="pre">function</span> <span class="pre">iglmin(a,n)</span></code></dt>
<dd>Calculates the (absolute) min of a vector that is size <code class="docutils literal"><span class="pre">n</span></code>. Prefix <code class="docutils literal"><span class="pre">i</span></code> implies integer type.</dd>
</dl>
<p><code class="docutils literal"><span class="pre">function</span> <span class="pre">glsc2(a,b,n)</span></code></p>
<p><code class="docutils literal"><span class="pre">function</span> <span class="pre">glsc3(a,b,mult,n)</span></code></p>
<dl class="docutils">
<dt><code class="docutils literal"><span class="pre">function</span> <span class="pre">glsc23(z,y,z,n)</span></code></dt>
<dd>Performs the inner product in double precision. <code class="docutils literal"><span class="pre">glsc3</span></code> uses a multiplier, <code class="docutils literal"><span class="pre">mult</span></code> and <code class="docutils literal"><span class="pre">glsc23</span></code> performs <code class="docutils literal"><span class="pre">x*x*y*z</span></code>.</dd>
</dl>
<p><code class="docutils literal"><span class="pre">function</span> <span class="pre">glsum(x,n)</span></code></p>
<p><code class="docutils literal"><span class="pre">function</span> <span class="pre">iglsum(x,n)</span></code></p>
<dl class="docutils">
<dt><code class="docutils literal"><span class="pre">function</span> <span class="pre">i8glsum(x,n)</span></code></dt>
<dd>Computes the global sum of <code class="docutils literal"><span class="pre">x</span></code>, where the prefix, <code class="docutils literal"><span class="pre">i</span></code> specifies type integer, and <code class="docutils literal"><span class="pre">i8</span></code> specifies type integer*8.</dd>
</dl>
</div>
<div class="section" id="an-example-of-specifying-surface-normals-in-the-usr-file">
<h2>An Example of Specifying Surface Normals in the .usr File<a class="headerlink" href="#an-example-of-specifying-surface-normals-in-the-usr-file" title="Permalink to this headline">¶</a></h2>
<div class="highlight-fortran"><div class="highlight"><pre><span></span><span class="k">subroutine </span><span class="n">userbc</span> <span class="p">(</span><span class="n">ix</span><span class="p">,</span><span class="n">iy</span><span class="p">,</span><span class="n">iz</span><span class="p">,</span><span class="n">iside</span><span class="p">,</span><span class="n">eg</span><span class="p">)</span>
<span class="k">include</span> <span class="s1">&#39;SIZE&#39;</span>
<span class="k">include</span> <span class="s1">&#39;TOTAL&#39;</span>
<span class="k">include</span> <span class="s1">&#39;NEKUSE&#39;</span>

<span class="kt">integer </span><span class="n">e</span><span class="p">,</span><span class="n">eg</span><span class="p">,</span><span class="n">f</span>
<span class="kt">real </span><span class="n">snx</span><span class="p">,</span><span class="n">sny</span><span class="p">,</span><span class="n">snz</span>   <span class="c">! surface normals</span>

<span class="n">f</span> <span class="o">=</span> <span class="n">eface1</span><span class="p">(</span><span class="n">iside</span><span class="p">)</span>
<span class="n">e</span> <span class="o">=</span> <span class="n">gllel</span> <span class="p">(</span><span class="n">eg</span><span class="p">)</span>

<span class="k">if</span> <span class="p">(</span><span class="n">f</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="mf">1.</span><span class="nb">or</span><span class="p">.</span><span class="n">f</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="mi">2</span><span class="p">)</span> <span class="k">then</span>      <span class="c">! &quot;r face&quot;</span>
   <span class="n">snx</span> <span class="o">=</span> <span class="n">unx</span><span class="p">(</span><span class="n">iy</span><span class="p">,</span><span class="n">iz</span><span class="p">,</span><span class="n">iside</span><span class="p">,</span><span class="n">e</span><span class="p">)</span>                 <span class="c">! Note:  iy,iz</span>
   <span class="n">sny</span> <span class="o">=</span> <span class="n">uny</span><span class="p">(</span><span class="n">iy</span><span class="p">,</span><span class="n">iz</span><span class="p">,</span><span class="n">iside</span><span class="p">,</span><span class="n">e</span><span class="p">)</span>
   <span class="n">snz</span> <span class="o">=</span> <span class="n">unz</span><span class="p">(</span><span class="n">iy</span><span class="p">,</span><span class="n">iz</span><span class="p">,</span><span class="n">iside</span><span class="p">,</span><span class="n">e</span><span class="p">)</span>
<span class="k">else if</span> <span class="p">(</span><span class="n">f</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="mf">3.</span><span class="nb">or</span><span class="p">.</span><span class="n">f</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="mi">4</span><span class="p">)</span>  <span class="k">then</span> <span class="c">! &quot;s face&quot;</span>
   <span class="n">snx</span> <span class="o">=</span> <span class="n">unx</span><span class="p">(</span><span class="n">ix</span><span class="p">,</span><span class="n">iz</span><span class="p">,</span><span class="n">iside</span><span class="p">,</span><span class="n">e</span><span class="p">)</span>                 <span class="c">!        ix,iz</span>
   <span class="n">sny</span> <span class="o">=</span> <span class="n">uny</span><span class="p">(</span><span class="n">ix</span><span class="p">,</span><span class="n">iz</span><span class="p">,</span><span class="n">iside</span><span class="p">,</span><span class="n">e</span><span class="p">)</span>
   <span class="n">snz</span> <span class="o">=</span> <span class="n">unz</span><span class="p">(</span><span class="n">ix</span><span class="p">,</span><span class="n">iz</span><span class="p">,</span><span class="n">iside</span><span class="p">,</span><span class="n">e</span><span class="p">)</span>
<span class="k">else if</span> <span class="p">(</span><span class="n">f</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="mf">5.</span><span class="nb">or</span><span class="p">.</span><span class="n">f</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="mi">6</span><span class="p">)</span>  <span class="k">then</span> <span class="c">! &quot;t face&quot;</span>
   <span class="n">snx</span> <span class="o">=</span> <span class="n">unx</span><span class="p">(</span><span class="n">ix</span><span class="p">,</span><span class="n">iy</span><span class="p">,</span><span class="n">iside</span><span class="p">,</span><span class="n">e</span><span class="p">)</span>                 <span class="c">!        ix,iy</span>
   <span class="n">sny</span> <span class="o">=</span> <span class="n">uny</span><span class="p">(</span><span class="n">ix</span><span class="p">,</span><span class="n">iy</span><span class="p">,</span><span class="n">iside</span><span class="p">,</span><span class="n">e</span><span class="p">)</span>
   <span class="n">snz</span> <span class="o">=</span> <span class="n">unz</span><span class="p">(</span><span class="n">ix</span><span class="p">,</span><span class="n">iy</span><span class="p">,</span><span class="n">iside</span><span class="p">,</span><span class="n">e</span><span class="p">)</span>
<span class="k">end if</span>

<span class="n">ux</span><span class="o">=</span><span class="mf">0.0</span>
<span class="n">uy</span><span class="o">=</span><span class="mf">0.0</span>
<span class="n">uz</span><span class="o">=</span><span class="mf">0.0</span>
<span class="n">temp</span><span class="o">=</span><span class="mf">0.0</span>

<span class="k">return</span>
<span class="k">end</span>
</pre></div>
</div>
<p>This example will load a list of field files (filenames are read from a file) into the solver using the <code class="docutils literal"><span class="pre">load_fld()</span></code> function. After the data is loaded, the user is free to compute other postprocessing quantities. At the end the results are dumped onto a regular (uniform) mesh by a subsequent call to <code class="docutils literal"><span class="pre">prepost()</span></code>.</p>
<p>Note: The regular grid data (field files) cannot be used as a restart file (uniform-&gt;GLL interpolation is unstable)!</p>
<div class="highlight-fortran"><div class="highlight"><pre><span></span><span class="k">subroutine </span><span class="n">userchk</span>
<span class="k">include</span> <span class="s1">&#39;SIZE&#39;</span>
<span class="k">include</span> <span class="s1">&#39;TOTAL&#39;</span>
<span class="k">include</span> <span class="s1">&#39;RESTART&#39;</span>

<span class="kt">character</span><span class="o">*</span><span class="mi">80</span> <span class="n">filename</span><span class="p">(</span><span class="mi">9999</span><span class="p">)</span>

<span class="n">ntot</span>   <span class="o">=</span> <span class="n">nx1</span><span class="o">*</span><span class="n">ny1</span><span class="o">*</span><span class="n">nz1</span><span class="o">*</span><span class="n">nelv</span>

<span class="n">ifreguo</span> <span class="o">=</span> <span class="p">.</span><span class="n">true</span><span class="p">.</span>   <span class="c">! dump on regular (uniform) grid instead of GLL</span>
<span class="n">nrg</span>     <span class="o">=</span> <span class="mi">16</span>       <span class="c">! dimension of regular grid (nrg**ndim)</span>

<span class="c">! read file-list</span>
<span class="k">if</span> <span class="p">(</span><span class="n">nid</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<span class="k">   open</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="mi">199</span><span class="p">,</span><span class="k">file</span><span class="o">=</span><span class="s1">&#39;file.list&#39;</span><span class="p">,</span><span class="n">form</span><span class="o">=</span><span class="s1">&#39;formatted&#39;</span><span class="p">,</span><span class="n">status</span><span class="o">=</span><span class="s1">&#39;old&#39;</span><span class="p">)</span>
   <span class="k">read</span><span class="p">(</span><span class="mi">199</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="n">nfiles</span>
   <span class="k">read</span><span class="p">(</span><span class="mi">199</span><span class="p">,</span><span class="s1">&#39;(A80)&#39;</span><span class="p">)</span> <span class="p">(</span><span class="n">filename</span><span class="p">(</span><span class="n">i</span><span class="p">),</span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">nfiles</span><span class="p">)</span>
   <span class="k">close</span><span class="p">(</span><span class="mi">199</span><span class="p">)</span>
<span class="k">end if</span>
<span class="k">call </span><span class="n">bcast</span><span class="p">(</span><span class="n">nfiles</span><span class="p">,</span><span class="n">isize</span><span class="p">)</span>
<span class="k">call </span><span class="n">bcast</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="n">nfiles</span><span class="o">*</span><span class="mi">80</span><span class="p">)</span>

<span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="n">nfiles</span>
   <span class="k">call </span><span class="n">load_fld</span><span class="p">(</span><span class="n">filename</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>

   <span class="c">! do something</span>
   <span class="c">! note: make sure you save the result into arrays which are</span>
   <span class="c">!       dumped by prepost() e.g. T(nx1,ny1,nz1,nelt,ldimt)</span>
   <span class="c">! ...</span>

   <span class="c">! dump results into file</span>
   <span class="k">call </span><span class="n">prepost</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="s1">&#39;his&#39;</span><span class="p">)</span>
<span class="k">end do</span>

<span class="c">! we&#39;re done</span>
<span class="k">call </span><span class="n">exitt</span>
</pre></div>
</div>
</div>
<div class="section" id="history-points">
<h2>History Points<a class="headerlink" href="#history-points" title="Permalink to this headline">¶</a></h2>
<p>Assuming a case named <code class="docutils literal"><span class="pre">blah</span></code>, a list of monitor points can be defined in file <code class="docutils literal"><span class="pre">blah.his</span></code> to evaluate velocity,
temperature, pressure and passive scalars. Results will be appended to this file each time subroutine <code class="docutils literal"><span class="pre">hpts()</span></code>
is called. Depending on the numnber of monitoring points you may need to increase parameter <code class="docutils literal"><span class="pre">lhis</span></code> in SIZE.
Usage example:</p>
<ul>
<li><p class="first">setup an ASCII file called <code class="docutils literal"><span class="pre">blah.his</span></code>, e.g.:</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>3 !number of monitoring points
1.1 -1.2 1.0
. . .
x y z
</pre></div>
</div>
</li>
<li><p class="first">add <code class="docutils literal"><span class="pre">call</span> <span class="pre">hpts()</span></code> to <code class="docutils literal"><span class="pre">userchk()</span></code></p>
</li>
</ul>
</div>
<div class="section" id="grid-to-grid-interpolation">
<h2>Grid-to-Grid Interpolation<a class="headerlink" href="#grid-to-grid-interpolation" title="Permalink to this headline">¶</a></h2>
<p>To restart from an existing field file (e.g. base.fld) onto a new mesh you can call the generic field file
reader interpolation subroutine in userchk. Note that selection of specific fields to read is not currently
supported. That means all fields included in base.fld will be overwritten. Usage example:</p>
<blockquote>
<div><div class="highlight-none"><div class="highlight"><pre><span></span>if (istep.eq.0) call gfldr(&#39;base.fld&#39;)
</pre></div>
</div>
</div></blockquote>
</div>
<div class="section" id="lagrangian-particle-tracking">
<h2>Lagrangian Particle Tracking<a class="headerlink" href="#lagrangian-particle-tracking" title="Permalink to this headline">¶</a></h2>
<p>The interpolation tool can be used for Lagrangian particle tracking (the particles are the interpolation points).</p>
<p>Workflow: Set initial particle positions (e.g. reading a file <code class="docutils literal"><span class="pre">particle.pos0</span></code>) <code class="docutils literal"><span class="pre">x_part</span> <span class="pre">&lt;-</span> <span class="pre">x_pos0</span></code></p>
<p>LOOP</p>
<ul class="simple">
<li>compute field quantities</li>
<li>interpolate field quantities for all particles using <code class="docutils literal"><span class="pre">intpts()</span></code></li>
<li>dump/store particle data</li>
<li>advect particles using <code class="docutils literal"><span class="pre">particle_advect()</span></code></li>
</ul>
<p>END LOOP</p>
<div class="highlight-fortranfixed"><div class="highlight"><pre><span></span><span class="nl">     </span> <span class="k">subroutine </span><span class="n">particle_advect</span><span class="p">(</span><span class="n">rtl</span><span class="p">,</span><span class="n">mr</span><span class="p">,</span><span class="n">npart</span><span class="p">,</span><span class="n">dt_p</span><span class="p">)</span>
<span class="c">c</span>
<span class="c">c     Advance particle position in time using 4th-order Adams-Bashford.</span>
<span class="c">c     U[x\_ i(t)] for a given x\_ i(t) will be evaluated by spectral interpolation.</span>
<span class="c">c     Note: The particle timestep dt_p has be constant!</span>
<span class="c">c</span>
<span class="nl">     </span> <span class="k">include</span> <span class="s1">&#39;SIZE&#39;</span>
<span class="nl">     </span> <span class="k">include</span> <span class="s1">&#39;TOTAL&#39;</span>

<span class="nl">     </span> <span class="kt">real </span><span class="n">rtl</span><span class="p">(</span><span class="n">mr</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>

<span class="nl">     </span> <span class="kt">real </span><span class="n">vell</span><span class="p">(</span><span class="n">ldim</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="n">lpart</span><span class="p">)</span>  <span class="c">! lagged velocities</span>
<span class="nl">     </span> <span class="k">save </span><span class="n">vell</span>

<span class="nl">     </span> <span class="kt">integer </span><span class="n">icalld</span>
<span class="nl">     </span> <span class="k">save    </span><span class="n">icalld</span>
<span class="nl">     </span> <span class="k">data    </span><span class="n">icalld</span> <span class="o">/</span><span class="mi">0</span><span class="o">/</span>

<span class="nl">     </span> <span class="k">if</span><span class="p">(</span><span class="n">npart</span><span class="p">.</span><span class="n">gt</span><span class="p">.</span><span class="n">lpart</span><span class="p">)</span> <span class="k">then</span>
<span class="nl">     </span>   <span class="k">write</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s1">&#39;ABORT: npart&gt;lpart - increase lpart in SIZE. &#39;</span><span class="p">,</span><span class="n">nid</span>
<span class="nl">     </span>   <span class="k">call </span><span class="n">exitt</span>
<span class="nl">     </span> <span class="k">end if</span>

<span class="nl">     </span> <span class="c">! compute AB coefficients (for constant timestep)</span>
<span class="nl">     </span> <span class="k">if</span> <span class="p">(</span><span class="n">icalld</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<span class="nl">     </span>    <span class="k">call </span><span class="n">rzero</span><span class="p">(</span><span class="n">vell</span><span class="p">,</span><span class="mi">3</span><span class="o">*</span><span class="n">ldim</span><span class="o">*</span><span class="n">npart</span><span class="p">)</span> <span class="c">! k = 1</span>
<span class="nl">     </span>    <span class="n">c0</span> <span class="o">=</span> <span class="mf">1.</span>
<span class="nl">     </span>    <span class="n">c1</span> <span class="o">=</span> <span class="mf">0.</span>
<span class="nl">     </span>    <span class="n">c2</span> <span class="o">=</span> <span class="mf">0.</span>
<span class="nl">     </span>    <span class="n">c3</span> <span class="o">=</span> <span class="mf">0.</span>
<span class="nl">     </span>    <span class="n">icalld</span> <span class="o">=</span> <span class="mi">1</span>
<span class="nl">     </span> <span class="k">else if</span> <span class="p">(</span><span class="n">icalld</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span> <span class="k">then</span>        <span class="c">! k = 2</span>
<span class="nl">     </span>    <span class="n">c0</span> <span class="o">=</span> <span class="mf">1.5</span>
<span class="nl">     </span>    <span class="n">c1</span> <span class="o">=</span> <span class="o">-</span><span class="p">.</span><span class="mi">5</span>
<span class="nl">     </span>    <span class="n">c2</span> <span class="o">=</span> <span class="mf">0.</span>
<span class="nl">     </span>    <span class="n">c3</span> <span class="o">=</span> <span class="mf">0.</span>
<span class="nl">     </span>    <span class="n">icalld</span> <span class="o">=</span> <span class="mi">2</span>
<span class="nl">     </span> <span class="k">else if</span> <span class="p">(</span><span class="n">icalld</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="mi">2</span><span class="p">)</span> <span class="k">then</span>        <span class="c">! k = 3</span>
<span class="nl">     </span>    <span class="n">c0</span> <span class="o">=</span> <span class="mi">2</span><span class="mf">3.</span>
<span class="nl">     </span>    <span class="n">c1</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="mf">6.</span>
<span class="nl">     </span>    <span class="n">c2</span> <span class="o">=</span> <span class="mf">5.</span>
<span class="nl">     </span>    <span class="n">c0</span> <span class="o">=</span> <span class="n">c0</span><span class="o">/</span><span class="mi">1</span><span class="mf">2.</span>
<span class="nl">     </span>    <span class="n">c1</span> <span class="o">=</span> <span class="n">c1</span><span class="o">/</span><span class="mi">1</span><span class="mf">2.</span>
<span class="nl">     </span>    <span class="n">c2</span> <span class="o">=</span> <span class="n">c2</span><span class="o">/</span><span class="mi">1</span><span class="mf">2.</span>
<span class="nl">     </span>    <span class="n">c3</span> <span class="o">=</span> <span class="mf">0.</span>
<span class="nl">     </span>    <span class="n">icalld</span> <span class="o">=</span> <span class="mi">3</span>
<span class="nl">     </span> <span class="k">else</span>                             <span class="c">! k = 4</span>
<span class="nl">     </span>    <span class="n">c0</span> <span class="o">=</span> <span class="mi">5</span><span class="mf">5.</span>
<span class="nl">     </span>    <span class="n">c1</span> <span class="o">=</span> <span class="o">-</span><span class="mi">5</span><span class="mf">9.</span>
<span class="nl">     </span>    <span class="n">c2</span> <span class="o">=</span> <span class="mi">3</span><span class="mf">7.</span>
<span class="nl">     </span>    <span class="n">c3</span> <span class="o">=</span> <span class="o">-</span><span class="mf">9.</span>
<span class="nl">     </span>    <span class="n">c0</span> <span class="o">=</span> <span class="n">c0</span><span class="o">/</span><span class="mi">2</span><span class="mf">4.</span>
<span class="nl">     </span>    <span class="n">c1</span> <span class="o">=</span> <span class="n">c1</span><span class="o">/</span><span class="mi">2</span><span class="mf">4.</span>
<span class="nl">     </span>    <span class="n">c2</span> <span class="o">=</span> <span class="n">c2</span><span class="o">/</span><span class="mi">2</span><span class="mf">4.</span>
<span class="nl">     </span>    <span class="n">c3</span> <span class="o">=</span> <span class="n">c3</span><span class="o">/</span><span class="mi">2</span><span class="mf">4.</span>
<span class="nl">     </span> <span class="k">end if</span>

<span class="nl">     </span> <span class="c">! compute new position x[t(n+1)]</span>
<span class="nl">     </span> <span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">npart</span>
<span class="nl">     </span>    <span class="k">do </span><span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">ndim</span>
<span class="nl">     </span>       <span class="n">vv</span> <span class="o">=</span> <span class="n">rtl</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">ndim</span><span class="o">+</span><span class="n">k</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
<span class="nl">     </span>       <span class="n">rtl</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">k</span><span class="p">,</span><span class="n">i</span><span class="p">)</span> <span class="o">=</span>  <span class="n">rtl</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">k</span><span class="p">,</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span>
<span class="nl">     </span><span class="gs">&amp;</span>                    <span class="n">dt_p</span><span class="o">*</span><span class="p">(</span>
<span class="nl">     </span><span class="gs">&amp;</span>                    <span class="o">+</span> <span class="n">c0</span><span class="o">*</span><span class="n">vv</span>
<span class="nl">     </span><span class="gs">&amp;</span>                    <span class="o">+</span> <span class="n">c1</span><span class="o">*</span><span class="n">vell</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
<span class="nl">     </span><span class="gs">&amp;</span>                    <span class="o">+</span> <span class="n">c2</span><span class="o">*</span><span class="n">vell</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
<span class="nl">     </span><span class="gs">&amp;</span>                    <span class="o">+</span> <span class="n">c3</span><span class="o">*</span><span class="n">vell</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
<span class="nl">     </span><span class="gs">&amp;</span>                    <span class="p">)</span>
<span class="nl">     </span>       <span class="c">! store velocity history</span>
<span class="nl">     </span>       <span class="n">vell</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="n">vell</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
<span class="nl">     </span>       <span class="n">vell</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="n">vell</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
<span class="nl">     </span>       <span class="n">vell</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="n">vv</span>
<span class="nl">     </span>    <span class="k">end do</span>
<span class="nl">     </span> <span class="k">end do</span>

<span class="nl">     </span> <span class="k">return</span>
<span class="nl">     </span> <span class="k">end</span>
</pre></div>
</div>
</div>
</div>


           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="appendix.html" class="btn btn-neutral float-right" title="Appendices" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="large_scale.html" class="btn btn-neutral" title="Performing Large-Scale Simulations in Nek5000" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017, Paul Fischer, James Lottes,  Stefan Kerkemeier, Oana Marin, Katherine Heisey, Aleks Obabko, Elia Merzari, Yulia Peet, Ronald Rahaman.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'./',
            VERSION:'17.0',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="_static/jquery.js"></script>
      <script type="text/javascript" src="_static/underscore.js"></script>
      <script type="text/javascript" src="_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>